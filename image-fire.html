<link rel="import" href="../polymer/polymer.html">

<dom-module id="image-fire">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <input type="file" id="file" multiple accept="image/*"> 
    </template>

  <script>
    /**
     * An element that allows simple upload of an image to Firebase storage
     * Example:
     * ```
     * <firebase-app
     *   name="demo"
     *   api-key="API_KEY"
     *   auth-domain="AUTH_DOMAIN"
     *   database-url="DATABASE_URL"
     *   storage-bucket="convoofire.appspot.com">
     * </firebase-app>
     * <!-- A image-fire element allowing image upload to firebase storage -->
     *  <image-fire 
     *       storage-path="/u/test"
     *       src-url="https://pbs.twimg.com/profile_images/741290730170122240/abfazODg_400x400.jpg"
     *       over-write
     *       max-size="500"
     *       progress="{{progress}}"
     *       base64="{{base64}}"
     *   ></image-fire>
     * ```
     *
     *
     * @demo demo/index.html
     */
    Polymer({
        is: 'image-fire',
        properties: {
        //     /**
        //     * `appName` represents the name of the firebase-app that was instantiated
        //     */
        appName: {
            type: String,
        },
        //     /**
        //     * `storagePath` represents where the file should be saved, if the path doesnt exist it will be created
        //     */
        storagePath: {
            type: String,
        },
        //     /**
        //     * `imageFrom` represents where to get the image from either an ID for a URL
        //     */
        srcUrl: {
            type: String,
            observer: "_loadImage",
        },
        //     /**
        //     * `overwrite` represents if a file can be overwritten or not, when set to false the file name will be prefixed with the curent epoch
        //     */
        srcFile: {
            type: Boolean,
            value: false,
        },
        //     /**
        //     * `overwrite` represents if a file can be overwritten or not, when set to false the file name will be prefixed with the curent epoch
        //     */
        overWrite: {
            type: Boolean,
            value: false,
        },
        //     /**
        //     * `overwrite` represents if a file can be overwritten or not, when set to false the file name will be prefixed with the curent epoch
        //     */
        makeSquare: {
            type: Boolean,
            value: false,
        },
        //     /**
        //     * `resize` represents the size the image will be resized to
        //     */
        maxSize: {
            type: Number,
            value: 0
        },
        //     /**
        //     * `progress` represents a percentage value for the file upload
        //     */
        progress: {
            type: Number,
            reflectToAttribute: true,
            notify: true,
        },
        //     /**
        //     * `base64` represents the size the image will be resized to
        //     */
        placeholder: {
            type: String,
            reflectToAttribute: true,
            notify: true,
        }
    },
    
    listeners: {
        'file.change' : '_loadImage'
    },

    ready: function() {
        if(!this.srcUrl && !this.srcFile){
            // GET IMAGE FROM STORAGE PATH
        }
    },

    _loadImage: function(event){
        img = new Image();
        if(typeof event == "string"){
            img.crossOrigin = "Anonymous";
            img.src = event; 
        } else {
            img.src = URL.createObjectURL(event.target.files[0]);
        }
        
        img.onload = function(){
            var canvas = document.createElement('canvas');
            var context = canvas.getContext('2d');
            context.drawImage(img, 0, 0, img.width, img.height);                
            var x = this._resizeBlob(canvas, this.maxSize, img.width, img.height, this.makeSquare, this.maxSize);
        }.bind(this)
    },

    _resizeBlob: function(canvas, targetSize, width, height, makeSquare, maxSize){
            var largestDim = Math.max(width, height);
            var canvas = canvas;
            var halved = false;
            if (largestDim * 2 > maxSize){
                    var canvas2 = document.createElement('canvas');
                    var context2 = canvas2.getContext('2d');
                    context2.drawImage(canvas, 0, 0, width * 0.5, height * 0.5);
                    var halved = true;
                    var canvas = canvas2;                
            } 
            // Now resize it to the target size and square it if needed

            // return the blob and the canvas, the canvs we pass around the blob we add to an array for upload
            var blob = canvas.toBlob(function(blob) {
                console.log(blob);
                console.log(canvas);
                return(blob)
            });
    }, // End resize blob



    });
  </script>
</dom-module>
