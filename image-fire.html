<link rel="import" href="../polymer/polymer.html">

<dom-module id="image-fire">
  <template>
    <style>
        :host {
            display: block;
        }
    </style>
  <input type="file" name="file" id="file"> 
  </template>

  <script>
    /**
     * An element that allows simple upload of an image to Firebase storage
     * Example:
     * ```
     * <firebase-app
     *   name="demo"
     *   api-key="API_KEY"
     *   auth-domain="AUTH_DOMAIN"
     *   database-url="DATABASE_URL"
     *   storage-bucket="convoofire.appspot.com">
     * </firebase-app>
     * <!-- A image-fire element allowing image upload to firebase storage -->
     * <image-fire 
     *  storage-path="/u/"
     *  image-from="https://pbs.twimg.com/profile_images/741290730170122240/abfazODg_bigger.jpg"
     *  progress="{{progress}}"
     *  overwrite="false"
     *  resize="300"
     * ></image-fire>
     * ```
     *
     *
     * @demo demo/index.html
     */
    Polymer({
        is: 'image-fire',
        properties: {
        //     /**
        //     * `appName` represents the name of the firebase-app that was instantiated
        //     */
        appName: {
            type: String,
        },
        //     /**
        //     * `appstoragePath` represents where the file should be saved, if the path doesnt exist it will be created
        //     */
        storagePath: {
            type: String,
        },
        //     /**
        //     * `imageFrom` represents where to get the image from either an ID for a URL
        //     */
        imageFrom: {
            type: String,
        },
        //     /**
        //     * `progress` represents a percentage value for the file upload
        //     */
        progress: {
            type: Number,
            reflectToAttribute: true
        },
        //     /**
        //     * `overwrite` represents if a file can be overwritten or not, when set to false the file name will be prefixed with the curent epoch
        //     */
        overWrite: {
            type: String,
        },
        //     /**
        //     * `fileName` represents the name of the file to sore to disk
        //     */
        fileName: {
            type: String,
        },
        //     /**
        //     * `resize` represents the size the image will be resized to
        //     */
        resize: {
            type: Number,
        }
    },
    
    listeners: {
        'file.change' : '_start'
    },

    attached: function(){  
        if(this.imageFrom){
            this._resizeThis(this.overWrite, this.fileName, this.resize, this.imageFrom, "blob").then(function(file){
                this._uploadThis(file, this.storagePath);
            }.bind(this));
        }
    },

    _start: function(e){
        this._resizeThis(this.overWrite, this.fileName, this.resize, e.target.files[0], "blob").then(function(file){
            this._uploadThis(file, this.storagePath);
        }.bind(this));
    },

    _uploadThis: function(file, storagePath){
        return new Promise(function(resolve, reject){
            // Check the Stprage path ends in a /     
            if(storagePath.slice(-1) !== '/'){
                storagePath = storagePath+'/'
            }
            // Get a reference to the storage service, which is used to create references in your storage bucket.
            var storage = firebase.storage();
            // Create a storage reference from our storage service.
            var storageRef = storage.ref();
            // Upload file and metadata to the object 'images/mountains.jpg'
            var uploadTask = storageRef.child(storagePath+file.name).put(file);
            // Listen for state changes, errors, and completion of the upload.
            uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
            function(snapshot) {
                // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload is ' + progress + '% done');
                switch (snapshot.state) {
                case firebase.storage.TaskState.PAUSED: // or 'paused'
                    console.log('Upload is paused');
                    break;
                case firebase.storage.TaskState.RUNNING: // or 'running'
                    console.log('Upload is running');
                    break;
                }
            }, function(error) {
            switch (error.code) {
                case 'storage/unauthorized':
                    console.log('Please adjust the storage rules in the Firebase console');
                    reject('storage/unauthorized');
                break;

                case 'storage/canceled':
                    console.log('Oopps! You canceled the upload');
                    reject('storage/canceled');
                break;

                case 'storage/unknown':
                    console.log('Unknown Error: '+ error.serverResponse);
                    reject('storage/unknown');
                break;
            }
            }, function() {
            // Upload completed successfully, now we can get the download URL
            var downloadURL = uploadTask.snapshot.downloadURL;
            console.log(downloadURL);
            resolve(downloadURL);
            });
        }); 
    },


    _resizeThis: function(overwrite, name, size, img, type){
            return new Promise(function(resolve, reject){
            var canvas = document.createElement("canvas");
            canvas.width = canvas.height = size;
            var ctx = canvas.getContext("2d");  
            var image = new Image();
            if(typeof img == "string"){
            image.src = img;
            } else {
                image.src = URL.createObjectURL(img);
            }
            image.crossOrigin = "Anonymous";
            image.onload = function() {
                ctx.drawImage(image, 0, 0, size, size);
                canvas.toBlob(function(blob) {
                    var myblob = blob;
                    var extension = blob.type.split("/");
                    var epoch = new Date().getTime();
                    if(overwrite == "yes"){
                        myblob.name = name+'_'+size+'.'+extension[1];  
                    } else{
                        myblob.name = epoch+'_'+name+'_'+size+'.'+extension[1];  
                    }
                    if(size > 6){
                        resolve(myblob);
                    } else {
                        var reader = new window.FileReader();
                        reader.readAsDataURL(myblob); 
                        reader.onloadend = function() {
                        base64data = reader.result;                
                        resolve(base64data);
                        }
                    }
                });
            }
            }); 
        } // End function "resizeThis" 


    });
  </script>
</dom-module>
